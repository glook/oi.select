"use strict";angular.module("oi.select",[]);var throttle=function(e,t,n){var r,o;return t||(t=250),function(){var l=n||this,i=+new Date,a=arguments;r&&i<r+t?(clearTimeout(o),o=setTimeout(function(){r=i,e.apply(l,a)},t)):(r=i,e.apply(l,a))}};angular.module("oi.select").provider("oiSelect",function(){return{options:{debounce:500,searchFilter:"oiSelectCloseIcon",dropdownFilter:"oiSelectHighlight",listFilter:"oiSelectAscSort",groupFilter:"oiSelectGroup",editItem:!1,newItem:!1,closeList:!0,saveTrigger:"enter tab blur",minlength:0},version:{full:"0.2.21",major:0,minor:2,dot:21},$get:function(){return{options:this.options,version:this.version}}}}).factory("oiSelectEscape",function(){var e=/[-\/\\^$*+?.()|[\]{}]/g;return function(t){return String(t).replace(e,"\\$&")}}).factory("oiSelectEditItem",function(){return function(e,t,n,r){return r?"":n(e)}}).factory("oiUtils",["$document","$timeout",function(e,t){function n(e,t,n){for(var r=t;r&&r.ownerDocument&&11!==r.nodeType;){if(n){if(r===e)return!1;if(r.className.indexOf(n)>=0)return!0}else if(r===e)return!0;r=r.parentNode}return!1}var r=new RegExp("^("+/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source+")(?!px)[a-z%]+$","i");function o(e){var t,n,r=e.getBoundingClientRect(),o=e&&e.ownerDocument;if(o)return t=o.documentElement,n=function(e){return null!=e&&e===e.window?e:9===e.nodeType&&e.defaultView}(o),{top:r.top+n.pageYOffset-t.clientTop,left:r.left+n.pageXOffset-t.clientLeft}}return{contains:n,bindFocusBlur:function(r,o){var l,i,a;function s(e){e&&"INPUT"!==e.target.nodeName||(a=!1,l=!1,i?a=!0:t(function(){r.triggerHandler("blur")}))}function u(){l||(l=!0,t(function(){r.triggerHandler("focus")}))}function c(){i=!0}function m(e){i=!1;var u=e.target,c=n(r[0],u);a&&!c&&s(),c&&"INPUT"!==u.nodeName&&t(function(){o[0].focus()}),!c&&l&&(l=!1)}return e[0].addEventListener("click",m,!0),r[0].addEventListener("mousedown",c,!0),r[0].addEventListener("blur",s,!0),o.on("focus",u),function(){e[0].removeEventListener("click",m,!0),r[0].removeEventListener("mousedown",c,!0),r[0].removeEventListener("blur",s,!0),o.off("focus",u)}},scrollActiveOption:function(e,t){var n,l,i,a,s,u;t&&(l=e.offsetHeight,i=function(e,t,n){var o="width"===t?e.offsetWidth:e.offsetHeight,l=window.getComputedStyle(e,null);if(o<=0||null==o){if(((o=l[t])<0||null==o)&&(o=e.style[t]),r.test(o))return o;o=parseFloat(o)||0}return o+function(e,t,n,r,o){var l=n===(r?"border":"content")?4:"width"===t?1:0,i=0,a=["Top","Right","Bottom","Left"];function s(e){return parseFloat(o[e])}for(;l<4;l+=2)"margin"===n&&(i+=s(n+a[l])),r?("content"===n&&(i-=s("padding"+a[l])),"margin"!==n&&(i-=s("border"+a[l]+"Width"))):(i+=s("padding"+a[l]),"padding"!==n&&(i+=s("border"+a[l]+"Width")));return i}(0,t,n||"content",!0,l)}(t,"height","margin"),a=e.scrollTop||0,s=n=o(t).top-o(e).top+a,u=n-l+i,n+i>l+a?e.scrollTop=u:n<a&&(e.scrollTop=s))},groupsIsEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t].length)return!1;return!0},getValue:function(e,t,n,r){var o={};return e.split(".").reduce(function(e,n,r,o){return e[n]=r<o.length-1?{}:t},o),r(n,o)},intersection:function(e,t,n,r,o){var l,i,a,s,u,c=o?[].concat(e):[];for(l=0,a=e.length;l<e.length;l++)for(s=n?n(e[l]):e[l],i=0;i<t.length;i++)if(u=r?r(t[i]):t[i],angular.equals(s,u,e,t,l,i)){o?c.splice(l+c.length-a,1):c.push(t[i]);break}return c}}}]),angular.module("oi.select").directive("oiSelect",["$document","$q","$timeout","$parse","$interpolate","$injector","$filter","$animate","oiUtils","oiSelect",function(e,t,n,r,o,l,i,a,s,u){var c=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?(?:\s+disable\s+when\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,m=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"src/template.html",require:"ngModel",scope:{},compile:function(e,p){var d=function(e){var t=e?e.match(c):["","i","","","","i","","",""];if(!t)throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var n={match:t};return n.selectAsName=/ as /.test(t[0])&&t[1],n.displayName=t[2]||t[1],n.valueName=t[5]||t[7],n.keyName=t[6],n.groupByName=t[3]||"",n.disableWhenName=t[4]||"",n.trackByName=t[9]||n.displayName,n.valueMatches=t[8].match(m),n.valueTitle=n.valueName,n.keyTitle=n.keyName,n.keyName&&(n.valueName="i",n.selectAsName=n.valueName+"."+(n.selectAsName||n.valueTitle),n.trackByName=n.valueName+"."+n.keyName,n.displayName=n.valueName+"."+n.displayName,n.keyName=n.valueName+"."+n.keyName,n.groupByName=n.groupByName?n.valueName+"."+n.groupByName:void 0,n.disableWhenName=n.disableWhenName?n.valueName+"."+n.disableWhenName:void 0),n.valuesName=n.valueMatches[1],n.filteredValuesName=n.valuesName+(n.valueMatches[3]||""),n.valuesFnName=n.valuesName+(n.valueMatches[2]||""),n.selectAsFn=n.selectAsName&&r(n.selectAsName),n.displayFn=r(n.displayName),n.groupByFn=r(n.groupByName),n.disableWhenFn=r(n.disableWhenName),n.filteredValuesFn=r(n.filteredValuesName),n.valuesFn=r(n.valuesFnName),n.trackByFn=r(n.trackByName),n.multiplePlaceholderFn=o(p.multiplePlaceholder||""),n.listPlaceholderFn=o(p.listPlaceholder||""),n.placeholderFn=o(p.placeholder||""),n.optionsFn=r(p.oiSelectOptions),n.isOldAngular=angular.version.major<=1&&angular.version.minor<=3,n},f=function(e,t){return Object.keys(e).forEach(function(n){void 0!==t[n]&&Array.isArray(t[n])&&(e[n]=e[n].concat(t[n]))}),e},h={placeholderFn:o(""),listPlaceholderFn:o(""),multiplePlaceholderFn:o(""),optionsFn:function(){}},g={keyUpDownWerePressed:null,matchesWereReset:null,timeoutPromise:null,lastQuery:null,removedItem:null,multiple:null,multipleLimit:null,newItemFn:null,offsetTop:0,noMoreItems:!1,threshold:30,throttle:500};return function(e,o,m,p){p.$isEmpty=function(e){return!K(e)};var v=o.find("input"),y=angular.element(o[0].querySelector(".select-dropdown")),$=h.placeholderFn(e)||m.placeholder||"",w=h.multiplePlaceholderFn(e)||m.multiplePlaceholder||"",F=h.listPlaceholderFn(e),N=h.optionsFn(e.$parent)||{},b=angular.extend({cleanModel:"prompt"===N.newItem},u.options,N),I=b.editItem,k="correct"===I,L=0;!0!==I&&"correct"!==I||(I="oiSelectEditItem");var P=I?l.get(I):angular.noop,S=r(b.removeItemFn);h.match=b.searchFilter.split(":");var E=i(h.match[0]),A=r(h.match[1]);h.match=b.dropdownFilter.split(":");var V=i(h.match[0]),q=r(h.match[1]);h.match=b.listFilter.split(":");var O=i(h.match[0]),C=r(h.match[1]);h.match=b.groupFilter.split(":");var T=i(h.match[0]),H=r(h.match[1]);b.newItemFn?g.newItemFn=r(b.newItemFn):g.newItemFn=function(e,t){return(h.optionsFn(t)||{}).newItemModel||t.$query},!b.cleanModel||I&&!k||o.addClass("cleanMode");var x=s.bindFocusBlur(o,v);function D(){k&&o.removeClass("cleanMode"),k=!1}angular.isDefined(m.autofocus)&&n(function(){v[0].focus()}),angular.isDefined(m.tabindex)&&(v.attr("tabindex",m.tabindex),o[0].removeAttribute("tabindex")),b.maxlength&&v.attr("maxlength",b.maxlength),m.$observe("disabled",function(t){v.prop("disabled",t),g.multiple&&p.$modelValue&&p.$modelValue.length&&(e.inputHide=t)}),e.$on("$destroy",x),e.$parent.$watch(m.multipleLimit,function(e){g.multipleLimit=Number(e)||1/0}),e.$parent.$watch(m.multiple,function(e){g.multiple=void 0===e?angular.isDefined(m.multiple):e,o[g.multiple?"addClass":"removeClass"]("multiple")}),e.$parent.$watch(m.ngModel,function(n,r){var o,l=J(n),i=t.when(l);o=g.multiple&&K(p.$modelValue)?w:$,v.attr("placeholder",o),K(r)&&n!==r&&D(),g.multiple||Q(),h.selectAsFn&&K(n)&&(i=Z(null,n).then(function(e){return s.intersection(l,e,null,G)}),g.timeoutPromise=null),g.multiple&&m.disabled&&!K(n)&&(e.inputHide=!1),i.then(function(t){e.output=t,t.length!==l.length&&e.removeItem(t.length)})}),e.$watch("query",function(t,n){R(t.slice(0,-1),t.slice(-1))||String(t).length<b.minlength||(t===n||e.oldQuery&&!t||g.matchesWereReset||(y[0].scrollTop=0,t?(Z(t),e.oldQuery=null):g.multiple&&(ee(),g.matchesWereReset=!0)),g.matchesWereReset=!1)}),e.$watch("groups",function(t){s.groupsIsEmpty(t)?e.isOpen=!1:e.isOpen||m.disabled||(e.isOpen=!0,e.isFocused=!0)}),e.$watch("isFocused",function(e){a[e?"addClass":"removeClass"](o,"focused",!h.isOldAngular&&{tempClasses:"focused-animate"})}),angular.isDefined(m.threshold)&&(isNaN(m.threshold)||(g.threshold=parseInt(m.threshold))),angular.isDefined(m.throttle)&&(isNaN(m.throttle)||(g.throttle=parseInt(m.throttle)));var M=function(e){setTimeout(function(){o[0].querySelector(".oi-select__dropdown").scrollTop=e},30)},W=throttle(function(t){var n=t.target;g.offsetTop=n.scrollTop,n.scrollTop+g.threshold+n.clientHeight>=n.scrollHeight&&(g.noMoreItems||Z(e.query,void 0,!0))},g.throttle);(e.$watch("isOpen",function(e){a[e?"addClass":"removeClass"](o,"open",!h.isOldAngular&&{tempClasses:"open-animate"}),e&&h.valuesFnName.match(/\$page/)&&setTimeout(function(){return o[0].addEventListener("scroll",W,!0)},100)}),e.$watch("isEmptyList",function(e){a[e?"addClass":"removeClass"](o,"emptyList",!h.isOldAngular&&{tempClasses:"emptyList-animate"})}),e.$watch("showLoader",function(e){a[e?"addClass":"removeClass"](o,"loading",!h.isOldAngular&&{tempClasses:"loading-animate"})}),angular.isDefined(m.readonly)&&e.$parent.$watch(m.readonly,function(e){void 0===e&&(e=!0),v.attr("readonly",e)}),angular.isDefined(m.oiOptions))&&(m.oiOptions.match(c)?h=d(m.oiOptions):e.$parent.$watch(m.oiOptions,function(e){h=d(e)}));function B(e,t){t=t||150,o.addClass(e),n(function(){o.removeClass(e)},t)}function _(){e.listItemHide=!0,e.inputHide=!1}function Q(){var t=K(p.$modelValue);e.listItemHide=!t,e.inputHide=t}function U(t){e.query.length<b.minlength||s.contains(o[0],t.target,"disabled")||e.output.length>=g.multipleLimit&&s.contains(o[0],t.target,"select-dropdown")||(e.inputHide&&e.removeItem(0),!e.isOpen||!b.closeList||"INPUT"===t.target.nodeName&&e.query.length?Z(e.query):(ee({query:b.editItem&&!k}),e.$evalAsync()))}function R(r,o){o||(o=r,r=e.query);var l=b.saveTrigger.split(" ").indexOf(o)+1,i=b.newItem&&r,a="blur"!==o?e.order[e.selectorPosition]:null;if(l&&(i||a&&!X(a)))return e.showLoader=!0,t.when(a||h.newItemFn(e.$parent,{$query:r})).then(function(r){if(void 0===r)return t.reject();e.addItem(r);var o=e.order.length-1;e.selectorPosition===o&&te(y,0),b.newItemFn&&!a||n(angular.noop),ee()}).catch(function(){B("invalid-item"),e.showLoader=!1}),!0}function j(t){return s.getValue(h.valueName,t,e.$parent,h.trackByFn)}function G(t){return s.getValue(h.valueName,t,e.$parent,h.selectAsFn)}function z(t){return s.getValue(h.valueName,t,e.$parent,h.displayFn)}function X(t){return e.isEmptyList||s.getValue(h.valueName,t,e.$parent,h.disableWhenFn)}function Y(t){return s.getValue(h.valueName,t,e.$parent,h.groupByFn)||""}function J(e){return(e=e instanceof Array?e:e?[e]:[]).filter(function(e){return void 0!==e&&(e instanceof Array&&e.length||h.selectAsFn||z(e))})}function K(e){return!!J(e).length}function Z(r,l){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return i?e.page++:e.page=0,e.isEmptyList=!1,g.timeoutPromise&&L&&n.cancel(g.timeoutPromise),g.timeoutPromise=n(function(){var a=h.valuesFn(e.$parent,{$query:r,$page:e.page,$selectedAs:l})||"";return e.selectorPosition="prompt"!==b.newItem&&0,r||l||(e.oldQuery=null),(a.$promise&&!a.$resolved||angular.isFunction(a.then))&&(L=b.debounce),e.showLoader=!0,t.when(a.$promise||a).then(function(t){if(i?t.length||(g.noMoreItems=!0):(e.groups={},g.noMoreItems=!1),t&&h.keyName){var n=[];angular.forEach(t,function(e,t){if("$"!==t.toString().charAt(0)){var r={};r[h.keyTitle]=t,r[h.valueTitle]=e,n.push(r)}}),t=n}if(t&&!l){var a=g.multiple?e.output:[],u=O(t,r,z,C(e.$parent),o),c=s.intersection(u,a,j,j,!0),m=(d=c,s.getValue(h.valuesName,d,e.$parent,h.filteredValuesFn));if(!m.length&&(e.isEmptyList=!0,F)){var p={};h.displayFn.assign(p,F),m=[p[h.valueName]]}i?(e.groups=f(e.groups,ne(m)),M(g.offsetTop)):e.groups=ne(m)}var d;return function(){var t,n,r,o=[],l=0;for(n in e.order=[],e.groupPos={},e.groups)e.groups.hasOwnProperty(n)&&"$"!==n.charAt(0)&&o.push(n);h.isOldAngular&&o.sort();for(t=0;t<o.length;t++)n=o[t],r=e.groups[n],e.order=e.order.concat(r),e.groupPos[n]=l,l+=r.length}(),t}).finally(function(){e.showLoader=!1,b.closeList&&!b.cleanModel&&n(function(){te(y,0)})})},L),g.timeoutPromise}function ee(t){t=t||{},e.oldQuery=null,e.backspaceFocus=!1,e.groups={},e.order=[],e.showLoader=!1,e.isOpen=!1,L=0,t.query||(e.query=""),g.timeoutPromise&&n.cancel(g.timeoutPromise)}function te(t,n){e.selectorPosition=n,s.scrollActiveOption(t[0],t.find("li")[n])}function ne(e){for(var t,n,r={"":[]},o=0;o<e.length;o++)(n=r[t=Y(e[o])])||(n=r[t]=[]),n.push(e[o]);return r}e.$parent.$watch(m.oiSelectOptions,function(e){b=angular.extend({cleanModel:"prompt"===N.newItem},u.options,e),I=b.editItem,k="correct"===I,L=0,!0!==I&&"correct"!==I||(I="oiSelectEditItem"),!0!==I&&"correct"!==I||(I="oiSelectEditItem"),P=I?l.get(I):angular.noop,S=r(b.removeItemFn),h.match=b.searchFilter.split(":"),E=i(h.match[0]),A=r(h.match[1]),h.match=b.dropdownFilter.split(":"),V=i(h.match[0]),q=r(h.match[1]),h.match=b.listFilter.split(":"),O=i(h.match[0]),C=r(h.match[1]),h.match=b.groupFilter.split(":"),T=i(h.match[0]),H=r(h.match[1]),b.newItemFn?g.newItemFn=r(b.newItemFn):g.newItemFn=function(e,t){return(h.optionsFn(t)||{}).newItemModel||t.$query}},!0),e.addItem=function(t){if(g.lastQuery=e.query,!g.multiple||!s.intersection(e.output,[t],j,j).length)if(e.output.length>=g.multipleLimit)B("limited");else{var n=e.groups[Y(t)]=e.groups[Y(t)]||[],r=h.selectAsFn?G(t):t;n.splice(n.indexOf(t),1),g.multiple?p.$setViewValue(angular.isArray(p.$modelValue)?p.$modelValue.concat(r):[r]):(p.$setViewValue(r),Q()),s.groupsIsEmpty(e.groups)&&(e.groups={}),g.multiple||b.closeList||ee({query:!0}),D(),e.oldQuery=e.oldQuery||e.query,e.query="",e.backspaceFocus=!1}},e.removeItem=function(n){m.disabled||g.multiple&&n<0||(g.removedItem=g.multiple?p.$modelValue[n]:p.$modelValue,t.when(S(e.$parent,{$item:g.removedItem})).then(function(){(g.multiple||e.inputHide)&&(g.multiple?(p.$modelValue.splice(n,1),p.$setViewValue([].concat(p.$modelValue))):(_(),b.cleanModel&&p.$setViewValue(void 0)),!g.multiple&&e.backspaceFocus||(e.query=P(g.removedItem,g.lastQuery,z,k,o)||""),g.multiple&&b.closeList&&ee({query:!0}))}))},e.setSelection=function(t){g.keyUpDownWerePressed||e.selectorPosition===t?g.keyUpDownWerePressed=!1:te(y,t)},e.keyUp=function(t){switch(t.keyCode){case 8:e.query.length||g.multiple&&e.output.length||ee()}},e.keyDown=function(t){var n=e.order.length-1;switch(t.keyCode){case 38:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:0,te(y,0===e.selectorPosition?n:e.selectorPosition-1),g.keyUpDownWerePressed=!0;break;case 40:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:-1,te(y,e.selectorPosition===n?0:e.selectorPosition+1),g.keyUpDownWerePressed=!0,e.query.length||e.isOpen||Z(),e.inputHide&&_();break;case 37:case 39:break;case 9:R("tab");break;case 13:R("enter"),t.preventDefault();break;case 32:R("space");break;case 27:g.multiple||(Q(),b.cleanModel&&p.$setViewValue(g.removedItem)),ee();break;case 8:if(!e.query.length){if(g.multiple&&!I||(e.backspaceFocus=!0),e.backspaceFocus&&e.output&&(!g.multiple||e.output.length)){e.removeItem(e.output.length-1),I&&t.preventDefault();break}e.backspaceFocus=!e.backspaceFocus;break}default:return e.inputHide&&_(),e.backspaceFocus=!1,!1}},e.getSearchLabel=function(t){var n=z(t);return E(n,e.oldQuery||e.query,t,A(e.$parent),o)},e.getDropdownLabel=function(t){var n=z(t);return V(n,e.oldQuery||e.query,t,q(e.$parent),o)},e.getGroupLabel=function(t,n){return T(t,e.oldQuery||e.query,n,H(e.$parent),o)},e.getDisableWhen=X,ee(),o[0].addEventListener("click",U,!0),e.$on("$destroy",function(){o[0].removeEventListener("click",U,!0)}),o.on("focus",function(t){if(e.isFocused)return;if(e.isFocused=!0,m.disabled)return;e.backspaceFocus=!1}),o.on("blur",function(t){e.isFocused=!1,g.multiple||Q();R("blur")||ee();e.$evalAsync()})}}}}]),angular.module("oi.select").filter("oiSelectGroup",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("oiSelectCloseIcon",["$sce",function(e){return function(t){return e.trustAsHtml(t+'<span class="close select-search-list-item_selection-remove">×</span>')}}]).filter("oiSelectHighlight",["$sce","oiSelectEscape",function(e,t){return function(n,r){var o;return r.length>0||angular.isNumber(r)?(n=n.toString(),r=t(r),o=n.replace(new RegExp(r,"gi"),"<strong>$&</strong>")):o=n,e.trustAsHtml(o)}}]).filter("oiSelectAscSort",["oiSelectEscape",function(e){return function(t,n,r,o){var l,i,a,s,u=[],c=[],m=[],p=[];if(n){for(n=e(n).toLocaleLowerCase(),l=0,a=!1;l<t.length;l++){if(!(a=r(t[l]).toLocaleLowerCase().match(new RegExp(n)))&&o&&(o.length||o.fields))for(i=0;i<o.length&&!a;i++)a=String(t[l][o[i]]).toLocaleLowerCase().match(new RegExp(n));a&&u.push(t[l])}for(l=0;l<u.length;l++)r(u[l]).toLocaleLowerCase().match(new RegExp("^"+n))?c.push(u[l]):m.push(u[l]);if(s=c.concat(m),o&&(!0===o||o.all)){e:for(l=0;l<t.length;l++){for(i=0;i<s.length;i++)if(t[l]===s[i])continue e;p.push(t[l])}s=s.concat(p)}}else s=[].concat(t);return s}}]).filter("none",function(){return function(e){return e}});