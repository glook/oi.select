"use strict";angular.module("oi.select",[]);var throttle=function(e,t,n){var r,o;return t||(t=250),function(){var i=n||this,l=+new Date,a=arguments;r&&l<r+t?(clearTimeout(o),o=setTimeout(function(){r=l,e.apply(i,a)},t)):(r=l,e.apply(i,a))}};angular.module("oi.select").provider("oiSelect",function(){return{options:{debounce:500,searchFilter:"oiSelectCloseIcon",dropdownFilter:"oiSelectHighlight",listFilter:"oiSelectAscSort",groupFilter:"oiSelectGroup",editItem:!1,newItem:!1,closeList:!0,saveTrigger:"enter tab blur",minlength:0},version:{full:"0.2.21",major:0,minor:2,dot:21},$get:function(){return{options:this.options,version:this.version}}}}).factory("oiSelectEscape",function(){var e=/[-\/\\^$*+?.()|[\]{}]/g;return function(t){return String(t).replace(e,"\\$&")}}).factory("oiSelectEditItem",function(){return function(e,t,n,r){return r?"":n(e)}}).factory("oiUtils",["$document","$timeout",function(e,t){function n(e,t,n){for(var r=t;r&&r.ownerDocument&&11!==r.nodeType;){if(n){if(r===e)return!1;if(r.className.indexOf(n)>=0)return!0}else if(r===e)return!0;r=r.parentNode}return!1}var r=new RegExp("^("+/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source+")(?!px)[a-z%]+$","i");function o(e){var t,n,r=e.getBoundingClientRect(),o=e&&e.ownerDocument;if(o)return t=o.documentElement,n=function(e){return null!=e&&e===e.window?e:9===e.nodeType&&e.defaultView}(o),{top:r.top+n.pageYOffset-t.clientTop,left:r.left+n.pageXOffset-t.clientLeft}}return{contains:n,bindFocusBlur:function(r,o){var i,l,a;function s(e){e&&"INPUT"!==e.target.nodeName||(a=!1,i=!1,l?a=!0:t(function(){r.triggerHandler("blur")}))}function u(){i||(i=!0,t(function(){r.triggerHandler("focus")}))}function c(){l=!0}function m(e){l=!1;var u=e.target,c=n(r[0],u);a&&!c&&s(),c&&"INPUT"!==u.nodeName&&t(function(){o[0].focus()}),!c&&i&&(i=!1)}return e[0].addEventListener("click",m,!0),r[0].addEventListener("mousedown",c,!0),r[0].addEventListener("blur",s,!0),o.on("focus",u),function(){e[0].removeEventListener("click",m,!0),r[0].removeEventListener("mousedown",c,!0),r[0].removeEventListener("blur",s,!0),o.off("focus",u)}},scrollActiveOption:function(e,t){var n,i,l,a,s,u;t&&(i=e.offsetHeight,l=function(e,t,n){var o="width"===t?e.offsetWidth:e.offsetHeight,i=window.getComputedStyle(e,null);if(o<=0||null==o){if(((o=i[t])<0||null==o)&&(o=e.style[t]),r.test(o))return o;o=parseFloat(o)||0}return o+function(e,t,n,r,o){var i=n===(r?"border":"content")?4:"width"===t?1:0,l=0,a=["Top","Right","Bottom","Left"];function s(e){return parseFloat(o[e])}for(;i<4;i+=2)"margin"===n&&(l+=s(n+a[i])),r?("content"===n&&(l-=s("padding"+a[i])),"margin"!==n&&(l-=s("border"+a[i]+"Width"))):(l+=s("padding"+a[i]),"padding"!==n&&(l+=s("border"+a[i]+"Width")));return l}(0,t,n||"content",!0,i)}(t,"height","margin"),a=e.scrollTop||0,s=n=o(t).top-o(e).top+a,u=n-i+l,n+l>i+a?e.scrollTop=u:n<a&&(e.scrollTop=s))},groupsIsEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t].length)return!1;return!0},getValue:function(e,t,n,r){var o={};return e.split(".").reduce(function(e,n,r,o){return e[n]=r<o.length-1?{}:t},o),r(n,o)},intersection:function(e,t,n,r,o){var i,l,a,s,u,c=o?[].concat(e):[];for(i=0,a=e.length;i<e.length;i++)for(s=n?n(e[i]):e[i],l=0;l<t.length;l++)if(u=r?r(t[l]):t[l],angular.equals(s,u,e,t,i,l)){o?c.splice(i+c.length-a,1):c.push(t[l]);break}return c}}}]),angular.module("oi.select").directive("oiSelect",["$document","$q","$timeout","$parse","$interpolate","$injector","$filter","$animate","oiUtils","oiSelect",function(e,t,n,r,o,i,l,a,s,u){var c=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?(?:\s+disable\s+when\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,m=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"src/template.html",require:"ngModel",scope:{},compile:function(e,p){var d=function(e){var t=e?e.match(c):["","i","","","","i","","",""];if(!t)throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var n={match:t};return n.selectAsName=/ as /.test(t[0])&&t[1],n.displayName=t[2]||t[1],n.valueName=t[5]||t[7],n.keyName=t[6],n.groupByName=t[3]||"",n.disableWhenName=t[4]||"",n.trackByName=t[9]||n.displayName,n.valueMatches=t[8].match(m),n.valueTitle=n.valueName,n.keyTitle=n.keyName,n.keyName&&(n.valueName="i",n.selectAsName=n.valueName+"."+(n.selectAsName||n.valueTitle),n.trackByName=n.valueName+"."+n.keyName,n.displayName=n.valueName+"."+n.displayName,n.keyName=n.valueName+"."+n.keyName,n.groupByName=n.groupByName?n.valueName+"."+n.groupByName:void 0,n.disableWhenName=n.disableWhenName?n.valueName+"."+n.disableWhenName:void 0),n.valuesName=n.valueMatches[1],n.filteredValuesName=n.valuesName+(n.valueMatches[3]||""),n.valuesFnName=n.valuesName+(n.valueMatches[2]||""),n.selectAsFn=n.selectAsName&&r(n.selectAsName),n.displayFn=r(n.displayName),n.groupByFn=r(n.groupByName),n.disableWhenFn=r(n.disableWhenName),n.filteredValuesFn=r(n.filteredValuesName),n.valuesFn=r(n.valuesFnName),n.trackByFn=r(n.trackByName),n.multiplePlaceholderFn=o(p.multiplePlaceholder||""),n.listPlaceholderFn=o(p.listPlaceholder||""),n.placeholderFn=o(p.placeholder||""),n.optionsFn=r(p.oiSelectOptions),n.isOldAngular=angular.version.major<=1&&angular.version.minor<=3,new Promise(function(e){return e(n)})},f=function(e,t){return Object.keys(e).forEach(function(n){void 0!==t[n]&&Array.isArray(t[n])&&(e[n]=e[n].concat(t[n]))}),e},h={keyUpDownWerePressed:null,matchesWereReset:null,timeoutPromise:null,lastQuery:null,removedItem:null,multiple:null,multipleLimit:null,newItemFn:null,offsetTop:0,noMoreItems:!1,threshold:30,throttle:500};return function(e,o,m,p){var g=function(e){return d(e).then(function(e){return v(e)})};angular.isDefined(m.oiOptions)&&(m.oiOptions.match(c)?g(m.oiOptions):e.$parent.$watch(m.oiOptions,function(e){g(e)}));angular.isDefined(m.oiSelectOptions)&&e.$parent.$watch(m.oiSelectOptions,function(){return g(m.oiOptions)},!0);var v=function(c){p.$isEmpty=function(e){return!Y(e)};var d=o.find("input"),g=angular.element(o[0].querySelector(".select-dropdown")),v=c.placeholderFn(e)||m.placeholder||"",y=c.multiplePlaceholderFn(e)||m.multiplePlaceholder||"",$=c.listPlaceholderFn(e),w=c.optionsFn(e.$parent)||{},N=angular.extend({cleanModel:"prompt"===w.newItem},u.options,w),b=N.editItem,F="correct"===b,k=0;!0!==b&&"correct"!==b||(b="oiSelectEditItem");var I=b?i.get(b):angular.noop,L=r(N.removeItemFn);c.match=N.searchFilter.split(":");var P=l(c.match[0]),S=r(c.match[1]);c.match=N.dropdownFilter.split(":");var A=l(c.match[0]),E=r(c.match[1]);c.match=N.listFilter.split(":");var V=l(c.match[0]),O=r(c.match[1]);c.match=N.groupFilter.split(":");var q=l(c.match[0]),T=r(c.match[1]);N.newItemFn?h.newItemFn=r(N.newItemFn):h.newItemFn=function(e,t){return(c.optionsFn(t)||{}).newItemModel||t.$query},!N.cleanModel||b&&!F||o.addClass("cleanMode");var C=s.bindFocusBlur(o,d);function D(){F&&o.removeClass("cleanMode"),F=!1}angular.isDefined(m.autofocus)&&n(function(){d[0].focus()}),angular.isDefined(m.tabindex)&&(d.attr("tabindex",m.tabindex),o[0].removeAttribute("tabindex")),N.maxlength&&d.attr("maxlength",N.maxlength),m.$observe("disabled",function(t){d.prop("disabled",t),h.multiple&&p.$modelValue&&p.$modelValue.length&&(e.inputHide=t)}),e.$on("$destroy",C),e.$parent.$watch(m.multipleLimit,function(e){h.multipleLimit=Number(e)||1/0}),e.$parent.$watch(m.multiple,function(e){h.multiple=void 0===e?angular.isDefined(m.multiple):e,o[h.multiple?"addClass":"removeClass"]("multiple")}),e.$parent.$watch(m.ngModel,function(n,r){var o,i=X(n),l=t.when(i);o=h.multiple&&Y(p.$modelValue)?y:v,d.attr("placeholder",o),Y(r)&&n!==r&&D(),h.multiple||B(),c.selectAsFn&&Y(n)&&(l=J(null,n).then(function(e){return s.intersection(i,e,null,R)}),h.timeoutPromise=null),h.multiple&&m.disabled&&!Y(n)&&(e.inputHide=!1),l.then(function(t){e.output=t,t.length!==i.length&&e.removeItem(t.length)})}),e.$watch("query",function(t,n){Q(t.slice(0,-1),t.slice(-1))||String(t).length<N.minlength||(t===n||e.oldQuery&&!t||h.matchesWereReset||(g[0].scrollTop=0,t?(J(t),e.oldQuery=null):h.multiple&&(K(),h.matchesWereReset=!0)),h.matchesWereReset=!1)}),e.$watch("groups",function(t){s.groupsIsEmpty(t)?e.isOpen=!1:e.isOpen||m.disabled||(e.isOpen=!0,e.isFocused=!0)}),e.$watch("isFocused",function(e){a[e?"addClass":"removeClass"](o,"focused",!c.isOldAngular&&{tempClasses:"focused-animate"})}),angular.isDefined(m.threshold)&&(isNaN(m.threshold)||(h.threshold=parseInt(m.threshold))),angular.isDefined(m.throttle)&&(isNaN(m.throttle)||(h.throttle=parseInt(m.throttle)));var H=function(e){setTimeout(function(){o[0].querySelector(".oi-select__dropdown").scrollTop=e},10)},W=throttle(function(t){var n=t.target;h.offsetTop=n.scrollTop,n.scrollTop+h.threshold+n.clientHeight>=n.scrollHeight&&(h.noMoreItems||J(e.query,void 0,!0))},h.throttle);function x(e,t){t=t||150,o.addClass(e),n(function(){o.removeClass(e)},t)}function M(){e.listItemHide=!0,e.inputHide=!1}function B(){var t=Y(p.$modelValue);e.listItemHide=!t,e.inputHide=t}function _(t){e.query.length<N.minlength||s.contains(o[0],t.target,"disabled")||e.output.length>=h.multipleLimit&&s.contains(o[0],t.target,"select-dropdown")||(e.inputHide&&e.removeItem(0),!e.isOpen||!N.closeList||"INPUT"===t.target.nodeName&&e.query.length?J(e.query):(K({query:N.editItem&&!F}),e.$evalAsync()))}function Q(r,o){o||(o=r,r=e.query);var i=N.saveTrigger.split(" ").indexOf(o)+1,l=N.newItem&&r,a="blur"!==o?e.order[e.selectorPosition]:null;if(i&&(l||a&&!G(a)))return e.showLoader=!0,t.when(a||c.newItemFn(e.$parent,{$query:r})).then(function(r){if(void 0===r)return t.reject();e.addItem(r);var o=e.order.length-1;e.selectorPosition===o&&Z(g,0),N.newItemFn&&!a||n(angular.noop),K()}).catch(function(){x("invalid-item"),e.showLoader=!1}),!0}function U(t){return s.getValue(c.valueName,t,e.$parent,c.trackByFn)}function R(t){return s.getValue(c.valueName,t,e.$parent,c.selectAsFn)}function j(t){return s.getValue(c.valueName,t,e.$parent,c.displayFn)}function G(t){return e.isEmptyList||s.getValue(c.valueName,t,e.$parent,c.disableWhenFn)}function z(t){return s.getValue(c.valueName,t,e.$parent,c.groupByFn)||""}function X(e){return(e=e instanceof Array?e:e?[e]:[]).filter(function(e){return void 0!==e&&(e instanceof Array&&e.length||c.selectAsFn||j(e))})}function Y(e){return!!X(e).length}function J(r,i){var l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return l?e.page++:e.page=0,e.isEmptyList=!1,h.timeoutPromise&&k&&n.cancel(h.timeoutPromise),h.timeoutPromise=n(function(){var a=c.valuesFn(e.$parent,{$query:r,$page:e.page,$selectedAs:i})||"";return e.selectorPosition="prompt"!==N.newItem&&0,r||i||(e.oldQuery=null),(a.$promise&&!a.$resolved||angular.isFunction(a.then))&&(k=N.debounce),e.showLoader=!0,t.when(a.$promise||a).then(function(t){if(l?(H(h.offsetTop),t.length||(h.noMoreItems=!0)):(e.groups={},h.noMoreItems=!1),t&&c.keyName){var n=[];angular.forEach(t,function(e,t){if("$"!==t.toString().charAt(0)){var r={};r[c.keyTitle]=t,r[c.valueTitle]=e,n.push(r)}}),t=n}if(t&&!i){var a=h.multiple?e.output:[],u=V(t,r,j,O(e.$parent),o),m=s.intersection(u,a,U,U,!0),p=(g=m,s.getValue(c.valuesName,g,e.$parent,c.filteredValuesFn));if(!p.length&&(e.isEmptyList=!0,$)){var d={};c.displayFn.assign(d,$),p=[d[c.valueName]]}l?(f(e.groups,ee(p)),H(h.offsetTop)):e.groups=ee(p)}var g;return function(){var t,n,r,o=[],i=0;for(n in e.order=[],e.groupPos={},e.groups)e.groups.hasOwnProperty(n)&&"$"!==n.charAt(0)&&o.push(n);c.isOldAngular&&o.sort();for(t=0;t<o.length;t++)n=o[t],r=e.groups[n],e.order=e.order.concat(r),e.groupPos[n]=i,i+=r.length}(),t}).finally(function(){e.showLoader=!1,N.closeList&&!N.cleanModel&&n(function(){Z(g,0)})})},k),h.timeoutPromise}function K(t){t=t||{},e.oldQuery=null,e.backspaceFocus=!1,e.groups={},e.order=[],e.showLoader=!1,e.isOpen=!1,k=0,t.query||(e.query=""),h.timeoutPromise&&n.cancel(h.timeoutPromise)}function Z(t,n){e.selectorPosition=n,s.scrollActiveOption(t[0],t.find("li")[n])}function ee(e){for(var t,n,r={"":[]},o=0;o<e.length;o++)(n=r[t=z(e[o])])||(n=r[t]=[]),n.push(e[o]);return r}e.$watch("isOpen",function(e){a[e?"addClass":"removeClass"](o,"open",!c.isOldAngular&&{tempClasses:"open-animate"}),e&&c.valuesFnName.match(/\$page/)&&setTimeout(function(){return o[0].addEventListener("scroll",W,!0)},100)}),e.$watch("isEmptyList",function(e){a[e?"addClass":"removeClass"](o,"emptyList",!c.isOldAngular&&{tempClasses:"emptyList-animate"})}),e.$watch("showLoader",function(e){a[e?"addClass":"removeClass"](o,"loading",!c.isOldAngular&&{tempClasses:"loading-animate"})}),angular.isDefined(m.readonly)&&e.$parent.$watch(m.readonly,function(e){void 0===e&&(e=!0),d.attr("readonly",e)}),e.addItem=function(t){if(h.lastQuery=e.query,!h.multiple||!s.intersection(e.output,[t],U,U).length)if(e.output.length>=h.multipleLimit)x("limited");else{var n=e.groups[z(t)]=e.groups[z(t)]||[],r=c.selectAsFn?R(t):t;n.splice(n.indexOf(t),1),h.multiple?p.$setViewValue(angular.isArray(p.$modelValue)?p.$modelValue.concat(r):[r]):(p.$setViewValue(r),B()),s.groupsIsEmpty(e.groups)&&(e.groups={}),h.multiple||N.closeList||K({query:!0}),D(),e.oldQuery=e.oldQuery||e.query,e.query="",e.backspaceFocus=!1}},e.removeItem=function(n){m.disabled||h.multiple&&n<0||(h.removedItem=h.multiple?p.$modelValue[n]:p.$modelValue,t.when(L(e.$parent,{$item:h.removedItem})).then(function(){(h.multiple||e.inputHide)&&(h.multiple?(p.$modelValue.splice(n,1),p.$setViewValue([].concat(p.$modelValue))):(M(),N.cleanModel&&p.$setViewValue(void 0)),!h.multiple&&e.backspaceFocus||(e.query=I(h.removedItem,h.lastQuery,j,F,o)||""),h.multiple&&N.closeList&&K({query:!0}))}))},e.setSelection=function(t){h.keyUpDownWerePressed||e.selectorPosition===t?h.keyUpDownWerePressed=!1:Z(g,t)},e.keyUp=function(t){switch(t.keyCode){case 8:e.query.length||h.multiple&&e.output.length||K()}},e.keyDown=function(t){var n=e.order.length-1;switch(t.keyCode){case 38:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:0,Z(g,0===e.selectorPosition?n:e.selectorPosition-1),h.keyUpDownWerePressed=!0;break;case 40:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:-1,Z(g,e.selectorPosition===n?0:e.selectorPosition+1),h.keyUpDownWerePressed=!0,e.query.length||e.isOpen||J(),e.inputHide&&M();break;case 37:case 39:break;case 9:Q("tab");break;case 13:Q("enter"),t.preventDefault();break;case 32:Q("space");break;case 27:h.multiple||(B(),N.cleanModel&&p.$setViewValue(h.removedItem)),K();break;case 8:if(!e.query.length){if(h.multiple&&!b||(e.backspaceFocus=!0),e.backspaceFocus&&e.output&&(!h.multiple||e.output.length)){e.removeItem(e.output.length-1),b&&t.preventDefault();break}e.backspaceFocus=!e.backspaceFocus;break}default:return e.inputHide&&M(),e.backspaceFocus=!1,!1}},e.getSearchLabel=function(t){var n=j(t);return P(n,e.oldQuery||e.query,t,S(e.$parent),o)},e.getDropdownLabel=function(t){var n=j(t);return A(n,e.oldQuery||e.query,t,E(e.$parent),o)},e.getGroupLabel=function(t,n){return q(t,e.oldQuery||e.query,n,T(e.$parent),o)},e.getDisableWhen=G,K(),o[0].addEventListener("click",_,!0),e.$on("$destroy",function(){o[0].removeEventListener("click",_,!0)}),o.on("focus",function(t){if(e.isFocused)return;if(e.isFocused=!0,m.disabled)return;e.backspaceFocus=!1}),o.on("blur",function(t){e.isFocused=!1,h.multiple||B();Q("blur")||K();e.$evalAsync()})}}}}}]),angular.module("oi.select").filter("oiSelectGroup",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("oiSelectCloseIcon",["$sce",function(e){return function(t){return e.trustAsHtml(t+'<span class="close select-search-list-item_selection-remove">×</span>')}}]).filter("oiSelectHighlight",["$sce","oiSelectEscape",function(e,t){return function(n,r){var o;return r.length>0||angular.isNumber(r)?(n=n.toString(),r=t(r),o=n.replace(new RegExp(r,"gi"),"<strong>$&</strong>")):o=n,e.trustAsHtml(o)}}]).filter("oiSelectAscSort",["oiSelectEscape",function(e){return function(t,n,r,o){var i,l,a,s,u=[],c=[],m=[],p=[];if(n){for(n=e(n).toLocaleLowerCase(),i=0,a=!1;i<t.length;i++){if(!(a=r(t[i]).toLocaleLowerCase().match(new RegExp(n)))&&o&&(o.length||o.fields))for(l=0;l<o.length&&!a;l++)a=String(t[i][o[l]]).toLocaleLowerCase().match(new RegExp(n));a&&u.push(t[i])}for(i=0;i<u.length;i++)r(u[i]).toLocaleLowerCase().match(new RegExp("^"+n))?c.push(u[i]):m.push(u[i]);if(s=c.concat(m),o&&(!0===o||o.all)){e:for(i=0;i<t.length;i++){for(l=0;l<s.length;l++)if(t[i]===s[l])continue e;p.push(t[i])}s=s.concat(p)}}else s=[].concat(t);return s}}]).filter("none",function(){return function(e){return e}});