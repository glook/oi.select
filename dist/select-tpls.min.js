"use strict";angular.module("oi.select",[]);var throttle=function(e,t,n){var o,i;return t||(t=250),function(){var r=n||this,l=+new Date,s=arguments;o&&l<o+t?(clearTimeout(i),i=setTimeout(function(){o=l,e.apply(r,s)},t)):(o=l,e.apply(r,s))}};angular.module("oi.select").provider("oiSelect",function(){return{options:{debounce:500,searchFilter:"oiSelectCloseIcon",dropdownFilter:"oiSelectHighlight",listFilter:"oiSelectAscSort",groupFilter:"oiSelectGroup",editItem:!1,newItem:!1,closeList:!0,saveTrigger:"enter tab blur",minlength:0},version:{full:"0.2.21",major:0,minor:2,dot:21},$get:function(){return{options:this.options,version:this.version}}}}).factory("oiSelectEscape",function(){var e=/[-\/\\^$*+?.()|[\]{}]/g;return function(t){return String(t).replace(e,"\\$&")}}).factory("oiSelectEditItem",function(){return function(e,t,n,o){return o?"":n(e)}}).factory("oiUtils",["$document","$timeout",function(e,t){function n(e,t,n){for(var o=t;o&&o.ownerDocument&&11!==o.nodeType;){if(n){if(o===e)return!1;if(o.className.indexOf(n)>=0)return!0}else if(o===e)return!0;o=o.parentNode}return!1}var o=new RegExp("^("+/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source+")(?!px)[a-z%]+$","i");function i(e){var t,n,o=e.getBoundingClientRect(),i=e&&e.ownerDocument;if(i)return t=i.documentElement,n=function(e){return null!=e&&e===e.window?e:9===e.nodeType&&e.defaultView}(i),{top:o.top+n.pageYOffset-t.clientTop,left:o.left+n.pageXOffset-t.clientLeft}}return{contains:n,bindFocusBlur:function(o,i){var r,l,s;function a(e){e&&"INPUT"!==e.target.nodeName||(s=!1,r=!1,l?s=!0:t(function(){o.triggerHandler("blur")}))}function u(){r||(r=!0,t(function(){o.triggerHandler("focus")}))}function c(){l=!0}function p(e){l=!1;var u=e.target,c=n(o[0],u);s&&!c&&a(),c&&"INPUT"!==u.nodeName&&t(function(){i[0].focus()}),!c&&r&&(r=!1)}return e[0].addEventListener("click",p,!0),o[0].addEventListener("mousedown",c,!0),o[0].addEventListener("blur",a,!0),i.on("focus",u),function(){e[0].removeEventListener("click",p,!0),o[0].removeEventListener("mousedown",c,!0),o[0].removeEventListener("blur",a,!0),i.off("focus",u)}},scrollActiveOption:function(e,t){var n,r,l,s,a,u;t&&(r=e.offsetHeight,l=function(e,t,n){var i="width"===t?e.offsetWidth:e.offsetHeight,r=window.getComputedStyle(e,null);if(i<=0||null==i){if(((i=r[t])<0||null==i)&&(i=e.style[t]),o.test(i))return i;i=parseFloat(i)||0}return i+function(e,t,n,o,i){var r=n===(o?"border":"content")?4:"width"===t?1:0,l=0,s=["Top","Right","Bottom","Left"];function a(e){return parseFloat(i[e])}for(;r<4;r+=2)"margin"===n&&(l+=a(n+s[r])),o?("content"===n&&(l-=a("padding"+s[r])),"margin"!==n&&(l-=a("border"+s[r]+"Width"))):(l+=a("padding"+s[r]),"padding"!==n&&(l+=a("border"+s[r]+"Width")));return l}(0,t,n||"content",!0,r)}(t,"height","margin"),s=e.scrollTop||0,a=n=i(t).top-i(e).top+s,u=n-r+l,n+l>r+s?e.scrollTop=u:n<s&&(e.scrollTop=a))},groupsIsEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t].length)return!1;return!0},getValue:function(e,t,n,o){var i={};return e.split(".").reduce(function(e,n,o,i){return e[n]=o<i.length-1?{}:t},i),o(n,i)},intersection:function(e,t,n,o,i){var r,l,s,a,u,c=i?[].concat(e):[];for(r=0,s=e.length;r<e.length;r++)for(a=n?n(e[r]):e[r],l=0;l<t.length;l++)if(u=o?o(t[l]):t[l],angular.equals(a,u,e,t,r,l)){i?c.splice(r+c.length-s,1):c.push(t[l]);break}return c}}}]),angular.module("oi.select").directive("oiSelect",["$document","$q","$timeout","$parse","$interpolate","$injector","$filter","$animate","oiUtils","oiSelect",function(e,t,n,o,i,r,l,s,a,u){var c=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?(?:\s+disable\s+when\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,p=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"src/template.html",require:"ngModel",scope:{},compile:function(e,d){var m=function(e){var t=e?e.match(c):["","i","","","","i","","",""];if(!t)throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var n={match:t};return n.selectAsName=/ as /.test(t[0])&&t[1],n.displayName=t[2]||t[1],n.valueName=t[5]||t[7],n.keyName=t[6],n.groupByName=t[3]||"",n.disableWhenName=t[4]||"",n.trackByName=t[9]||n.displayName,n.valueMatches=t[8].match(p),n.valueTitle=n.valueName,n.keyTitle=n.keyName,n.keyName&&(n.valueName="i",n.selectAsName=n.valueName+"."+(n.selectAsName||n.valueTitle),n.trackByName=n.valueName+"."+n.keyName,n.displayName=n.valueName+"."+n.displayName,n.keyName=n.valueName+"."+n.keyName,n.groupByName=n.groupByName?n.valueName+"."+n.groupByName:void 0,n.disableWhenName=n.disableWhenName?n.valueName+"."+n.disableWhenName:void 0),n.valuesName=n.valueMatches[1],n.filteredValuesName=n.valuesName+(n.valueMatches[3]||""),n.valuesFnName=n.valuesName+(n.valueMatches[2]||""),n.selectAsFn=n.selectAsName&&o(n.selectAsName),n.displayFn=o(n.displayName),n.groupByFn=o(n.groupByName),n.disableWhenFn=o(n.disableWhenName),n.filteredValuesFn=o(n.filteredValuesName),n.valuesFn=o(n.valuesFnName),n.trackByFn=o(n.trackByName),n.multiplePlaceholderFn=i(d.multiplePlaceholder||""),n.listPlaceholderFn=i(d.listPlaceholder||""),n.placeholderFn=i(d.placeholder||""),n.optionsFn=o(d.oiSelectOptions),n.isOldAngular=angular.version.major<=1&&angular.version.minor<=3,new Promise(function(e){return e(n)})},f=function(e,t){return Object.keys(e).forEach(function(n){void 0!==t[n]&&Array.isArray(t[n])&&(e[n]=e[n].concat(t[n]))}),e},h={keyUpDownWerePressed:null,matchesWereReset:null,timeoutPromise:null,lastQuery:null,removedItem:null,multiple:null,multipleLimit:null,newItemFn:null,offsetTop:0,noMoreItems:!1,threshold:30,throttle:500};return function(e,i,p,d){var g=function(e){return m(e).then(function(e){return v(e)})};angular.isDefined(p.oiOptions)&&(p.oiOptions.match(c)?g(p.oiOptions):e.$parent.$watch(p.oiOptions,function(e){g(e)}));angular.isDefined(p.oiSelectOptions)&&e.$parent.$watch(p.oiSelectOptions,function(){return g(p.oiOptions)},!0);var v=function(c){d.$isEmpty=function(e){return!Y(e)};var m=i.find("input"),g=angular.element(i[0].querySelector(".select-dropdown")),v=c.placeholderFn(e)||p.placeholder||"",y=c.multiplePlaceholderFn(e)||p.multiplePlaceholder||"",w=c.listPlaceholderFn(e),$=c.optionsFn(e.$parent)||{},b=angular.extend({cleanModel:"prompt"===$.newItem},u.options,$),N=b.editItem,F="correct"===N,k=0;!0!==N&&"correct"!==N||(N="oiSelectEditItem");var I=N?r.get(N):angular.noop,L=o(b.removeItemFn);c.match=b.searchFilter.split(":");var _=l(c.match[0]),P=o(c.match[1]);c.match=b.dropdownFilter.split(":");var S=l(c.match[0]),A=o(c.match[1]);c.match=b.listFilter.split(":");var E=l(c.match[0]),O=o(c.match[1]);c.match=b.groupFilter.split(":");var V=l(c.match[0]),q=o(c.match[1]);b.newItemFn?h.newItemFn=o(b.newItemFn):h.newItemFn=function(e,t){return(c.optionsFn(t)||{}).newItemModel||t.$query},!b.cleanModel||N&&!F||i.addClass("cleanMode");var C=a.bindFocusBlur(i,m);function T(){F&&i.removeClass("cleanMode"),F=!1}angular.isDefined(p.autofocus)&&n(function(){m[0].focus()}),angular.isDefined(p.tabindex)&&(m.attr("tabindex",p.tabindex),i[0].removeAttribute("tabindex")),b.maxlength&&m.attr("maxlength",b.maxlength),p.$observe("disabled",function(t){m.prop("disabled",t),h.multiple&&d.$modelValue&&d.$modelValue.length&&(e.inputHide=t)}),e.$on("$destroy",C),e.$parent.$watch(p.multipleLimit,function(e){h.multipleLimit=Number(e)||1/0}),e.$parent.$watch(p.multiple,function(e){h.multiple=void 0===e?angular.isDefined(p.multiple):e,i[h.multiple?"addClass":"removeClass"]("multiple")}),e.$parent.$watch(p.ngModel,function(n,o){var i,r=X(n),l=t.when(r);i=h.multiple&&Y(d.$modelValue)?y:v,m.attr("placeholder",i),Y(o)&&n!==o&&T(),h.multiple||M(),c.selectAsFn&&Y(n)&&(l=J(null,n).then(function(e){return a.intersection(r,e,null,R)}),h.timeoutPromise=null),h.multiple&&p.disabled&&!Y(n)&&(e.inputHide=!1),l.then(function(t){e.output=t,t.length!==r.length&&e.removeItem(t.length)})}),e.$watch("query",function(t,n){U(t.slice(0,-1),t.slice(-1))||String(t).length<b.minlength||(t===n||e.oldQuery&&!t||h.matchesWereReset||(g[0].scrollTop=0,t?(J(t),e.oldQuery=null):h.multiple&&(K(),h.matchesWereReset=!0)),h.matchesWereReset=!1)}),e.$watch("groups",function(t){a.groupsIsEmpty(t)?e.isOpen=!1:e.isOpen||p.disabled||(e.isOpen=!0,e.isFocused=!0)}),e.$watch("isFocused",function(e){s[e?"addClass":"removeClass"](i,"focused",!c.isOldAngular&&{tempClasses:"focused-animate"})}),angular.isDefined(p.threshold)&&(isNaN(p.threshold)||(h.threshold=parseInt(p.threshold))),angular.isDefined(p.throttle)&&(isNaN(p.throttle)||(h.throttle=parseInt(p.throttle)));var D=function(e){setTimeout(function(){i[0].querySelector(".oi-select__dropdown").scrollTop=e},10)},x=throttle(function(t){var n=t.target;h.offsetTop=n.scrollTop,n.scrollTop+h.threshold+n.clientHeight>=n.scrollHeight&&(h.noMoreItems||J(e.query,void 0,!0))},h.throttle);function H(e,t){t=t||150,i.addClass(e),n(function(){i.removeClass(e)},t)}function W(){e.listItemHide=!0,e.inputHide=!1}function M(){var t=Y(d.$modelValue);e.listItemHide=!t,e.inputHide=t}function B(t){e.query.length<b.minlength||a.contains(i[0],t.target,"disabled")||e.output.length>=h.multipleLimit&&a.contains(i[0],t.target,"select-dropdown")||(e.inputHide&&e.removeItem(0),!e.isOpen||!b.closeList||"INPUT"===t.target.nodeName&&e.query.length?J(e.query):(K({query:b.editItem&&!F}),e.$evalAsync()))}function U(o,i){i||(i=o,o=e.query);var r=b.saveTrigger.split(" ").indexOf(i)+1,l=b.newItem&&o,s="blur"!==i?e.order[e.selectorPosition]:null;if(r&&(l||s&&!G(s)))return e.showLoader=!0,t.when(s||c.newItemFn(e.$parent,{$query:o})).then(function(o){if(void 0===o)return t.reject();e.addItem(o);var i=e.order.length-1;e.selectorPosition===i&&Z(g,0),b.newItemFn&&!s||n(angular.noop),K()}).catch(function(){H("invalid-item"),e.showLoader=!1}),!0}function Q(t){return a.getValue(c.valueName,t,e.$parent,c.trackByFn)}function R(t){return a.getValue(c.valueName,t,e.$parent,c.selectAsFn)}function j(t){return a.getValue(c.valueName,t,e.$parent,c.displayFn)}function G(t){return e.isEmptyList||a.getValue(c.valueName,t,e.$parent,c.disableWhenFn)}function z(t){return a.getValue(c.valueName,t,e.$parent,c.groupByFn)||""}function X(e){return(e=e instanceof Array?e:e?[e]:[]).filter(function(e){return void 0!==e&&(e instanceof Array&&e.length||c.selectAsFn||j(e))})}function Y(e){return!!X(e).length}function J(o,r){var l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return l?e.page++:e.page=0,e.isEmptyList=!1,h.timeoutPromise&&k&&n.cancel(h.timeoutPromise),h.timeoutPromise=n(function(){var s=c.valuesFn(e.$parent,{$query:o,$page:e.page,$selectedAs:r})||"";return e.selectorPosition="prompt"!==b.newItem&&0,o||r||(e.oldQuery=null),(s.$promise&&!s.$resolved||angular.isFunction(s.then))&&(k=b.debounce),e.showLoader=!0,t.when(s.$promise||s).then(function(t){if(l?(D(h.offsetTop),t.length||(h.noMoreItems=!0)):(e.groups={},h.noMoreItems=!1),t&&c.keyName){var n=[];angular.forEach(t,function(e,t){if("$"!==t.toString().charAt(0)){var o={};o[c.keyTitle]=t,o[c.valueTitle]=e,n.push(o)}}),t=n}if(t&&!r){var s=h.multiple?e.output:[],u=E(t,o,j,O(e.$parent),i),p=a.intersection(u,s,Q,Q,!0),d=(g=p,a.getValue(c.valuesName,g,e.$parent,c.filteredValuesFn));if(!d.length&&(e.isEmptyList=!0,w)){var m={};c.displayFn.assign(m,w),d=[m[c.valueName]]}l?(f(e.groups,ee(d)),D(h.offsetTop)):e.groups=ee(d)}var g;return function(){var t,n,o,i=[],r=0;for(n in e.order=[],e.groupPos={},e.groups)e.groups.hasOwnProperty(n)&&"$"!==n.charAt(0)&&i.push(n);c.isOldAngular&&i.sort();for(t=0;t<i.length;t++)n=i[t],o=e.groups[n],e.order=e.order.concat(o),e.groupPos[n]=r,r+=o.length}(),t}).finally(function(){e.showLoader=!1,b.closeList&&!b.cleanModel&&n(function(){Z(g,0)})})},k),h.timeoutPromise}function K(t){t=t||{},e.oldQuery=null,e.backspaceFocus=!1,e.groups={},e.order=[],e.showLoader=!1,e.isOpen=!1,k=0,t.query||(e.query=""),h.timeoutPromise&&n.cancel(h.timeoutPromise)}function Z(t,n){e.selectorPosition=n,a.scrollActiveOption(t[0],t.find("li")[n])}function ee(e){for(var t,n,o={"":[]},i=0;i<e.length;i++)(n=o[t=z(e[i])])||(n=o[t]=[]),n.push(e[i]);return o}e.$watch("isOpen",function(e){s[e?"addClass":"removeClass"](i,"open",!c.isOldAngular&&{tempClasses:"open-animate"}),e&&c.valuesFnName.match(/\$page/)&&setTimeout(function(){return i[0].addEventListener("scroll",x,!0)},100)}),e.$watch("isEmptyList",function(e){s[e?"addClass":"removeClass"](i,"emptyList",!c.isOldAngular&&{tempClasses:"emptyList-animate"})}),e.$watch("showLoader",function(e){s[e?"addClass":"removeClass"](i,"loading",!c.isOldAngular&&{tempClasses:"loading-animate"})}),angular.isDefined(p.readonly)&&e.$parent.$watch(p.readonly,function(e){void 0===e&&(e=!0),m.attr("readonly",e)}),e.addItem=function(t){if(h.lastQuery=e.query,!h.multiple||!a.intersection(e.output,[t],Q,Q).length)if(e.output.length>=h.multipleLimit)H("limited");else{var n=e.groups[z(t)]=e.groups[z(t)]||[],o=c.selectAsFn?R(t):t;n.splice(n.indexOf(t),1),h.multiple?d.$setViewValue(angular.isArray(d.$modelValue)?d.$modelValue.concat(o):[o]):(d.$setViewValue(o),M()),a.groupsIsEmpty(e.groups)&&(e.groups={}),h.multiple||b.closeList||K({query:!0}),T(),e.oldQuery=e.oldQuery||e.query,e.query="",e.backspaceFocus=!1}},e.removeItem=function(n){p.disabled||h.multiple&&n<0||(h.removedItem=h.multiple?d.$modelValue[n]:d.$modelValue,t.when(L(e.$parent,{$item:h.removedItem})).then(function(){(h.multiple||e.inputHide)&&(h.multiple?(d.$modelValue.splice(n,1),d.$setViewValue([].concat(d.$modelValue))):(W(),b.cleanModel&&d.$setViewValue(void 0)),!h.multiple&&e.backspaceFocus||(e.query=I(h.removedItem,h.lastQuery,j,F,i)||""),h.multiple&&b.closeList&&K({query:!0}))}))},e.setSelection=function(t){h.keyUpDownWerePressed||e.selectorPosition===t?h.keyUpDownWerePressed=!1:Z(g,t)},e.keyUp=function(t){switch(t.keyCode){case 8:e.query.length||h.multiple&&e.output.length||K()}},e.keyDown=function(t){var n=e.order.length-1;switch(t.keyCode){case 38:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:0,Z(g,0===e.selectorPosition?n:e.selectorPosition-1),h.keyUpDownWerePressed=!0;break;case 40:e.selectorPosition=angular.isNumber(e.selectorPosition)?e.selectorPosition:-1,Z(g,e.selectorPosition===n?0:e.selectorPosition+1),h.keyUpDownWerePressed=!0,e.query.length||e.isOpen||J(),e.inputHide&&W();break;case 37:case 39:break;case 9:U("tab");break;case 13:U("enter"),t.preventDefault();break;case 32:U("space");break;case 27:h.multiple||(M(),b.cleanModel&&d.$setViewValue(h.removedItem)),K();break;case 8:if(!e.query.length){if(h.multiple&&!N||(e.backspaceFocus=!0),e.backspaceFocus&&e.output&&(!h.multiple||e.output.length)){e.removeItem(e.output.length-1),N&&t.preventDefault();break}e.backspaceFocus=!e.backspaceFocus;break}default:return e.inputHide&&W(),e.backspaceFocus=!1,!1}},e.getSearchLabel=function(t){var n=j(t);return _(n,e.oldQuery||e.query,t,P(e.$parent),i)},e.getDropdownLabel=function(t){var n=j(t);return S(n,e.oldQuery||e.query,t,A(e.$parent),i)},e.getGroupLabel=function(t,n){return V(t,e.oldQuery||e.query,n,q(e.$parent),i)},e.getDisableWhen=G,K(),i[0].addEventListener("click",B,!0),e.$on("$destroy",function(){i[0].removeEventListener("click",B,!0)}),i.on("focus",function(t){if(e.isFocused)return;if(e.isFocused=!0,p.disabled)return;e.backspaceFocus=!1}),i.on("blur",function(t){e.isFocused=!1,h.multiple||M();U("blur")||K();e.$evalAsync()})}}}}}]),angular.module("oi.select").filter("oiSelectGroup",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("oiSelectCloseIcon",["$sce",function(e){return function(t){return e.trustAsHtml(t+'<span class="close select-search-list-item_selection-remove">×</span>')}}]).filter("oiSelectHighlight",["$sce","oiSelectEscape",function(e,t){return function(n,o){var i;return o.length>0||angular.isNumber(o)?(n=n.toString(),o=t(o),i=n.replace(new RegExp(o,"gi"),"<strong>$&</strong>")):i=n,e.trustAsHtml(i)}}]).filter("oiSelectAscSort",["oiSelectEscape",function(e){return function(t,n,o,i){var r,l,s,a,u=[],c=[],p=[],d=[];if(n){for(n=e(n).toLocaleLowerCase(),r=0,s=!1;r<t.length;r++){if(!(s=o(t[r]).toLocaleLowerCase().match(new RegExp(n)))&&i&&(i.length||i.fields))for(l=0;l<i.length&&!s;l++)s=String(t[r][i[l]]).toLocaleLowerCase().match(new RegExp(n));s&&u.push(t[r])}for(r=0;r<u.length;r++)o(u[r]).toLocaleLowerCase().match(new RegExp("^"+n))?c.push(u[r]):p.push(u[r]);if(a=c.concat(p),i&&(!0===i||i.all)){e:for(r=0;r<t.length;r++){for(l=0;l<a.length;l++)if(t[r]===a[l])continue e;d.push(t[r])}a=a.concat(d)}}else a=[].concat(t);return a}}]).filter("none",function(){return function(e){return e}}),angular.module("oi.select").run(["$templateCache",function(e){e.put("src/template.html",'<div class="oi-select__search select-search"><ul class="select-search-list oi-select__search-list"><li class="select-search-list-item oi-select__search-list-item select-search-list-item_selection oi-select__search-list-item_selection" ng-hide=listItemHide ng-repeat="item in output track by $index" ng-class="{focused: backspaceFocus && $last}" ng-click=removeItem($index) ng-bind-html=getSearchLabel(item)></li><li class="select-search-list-item oi-select__search-list-item select-search-list-item_input oi-select__search-list-item_input" ng-class="{\'select-search-list-item_hide oi-select__search-list-item_hide\': inputHide}"><input autocomplete=off ng-model=query ng-keyup=keyUp($event) ng-keydown=keyDown($event)></li><li class="select-search-list-item oi-select__search-list-item select-search-list-item_loader oi-select__search-list-item_loader" ng-show=showLoader></li></ul></div><div class="oi-select__dropdown select-dropdown" ng-show=isOpen><ul ng-if=isOpen class="select-dropdown-optgroup oi-select__dropdown-optgroup" ng-repeat="(group, options) in groups"><div class="select-dropdown-optgroup-header oi-select__dropdown-optgroup-header" ng-if="group && options.length" ng-bind-html="getGroupLabel(group, options)"></div><li class="select-dropdown-optgroup-option oi-select__dropdown-optgroup-option" ng-init="isDisabled = getDisableWhen(option)" ng-repeat="option in options" ng-class="{\'active\': selectorPosition === groupPos[group] + $index, \'disabled\': isDisabled, \'ungroup\': !group}" ng-click="isDisabled || addItem(option)" ng-mouseenter="setSelection(groupPos[group] + $index)" ng-bind-html=getDropdownLabel(option)></li></ul></div>')}]);